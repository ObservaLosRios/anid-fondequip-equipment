<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Equipos por región de instalación</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <style>
        :root {
            --font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --page-bg: #ffffff;
            --panel-bg: #ffffff;
            --text-color: #0f172a;
            --muted-color: #475569;
            --button-bg: #ffffff;
            --button-border: #cbd5f5;
            --button-text: #0f172a;
        }
        body {
            margin: 0;
            font-family: var(--font-family);
            background: var(--page-bg);
            color: var(--text-color);
        }
        .dashboard {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0;
        }
        .card {
            background: var(--panel-bg);
            border-radius: 0;
            padding: 0;
            box-shadow: none;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            flex-wrap: wrap;
            padding: 20px 24px 0;
            margin-bottom: 12px;
        }
        .header-actions {
            position: relative;
            display: flex;
            align-items: center;
        }
        h1 {
            margin: 0;
            font-size: clamp(1.2rem, 2vw, 1.6rem);
        }
        p.subtitle {
            margin: 4px 0 0;
            color: var(--muted-color);
            font-size: 0.95rem;
        }
        #exportToggle {
            border: 1px solid rgba(0, 0, 0, 0.25);
            background: #f7f7f7;
            color: rgba(0, 0, 0, 0.75);
            border-radius: 2px;
            width: 30px;
            height: 30px;
            display: grid;
            place-items: center;
            font-size: 16px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        #exportToggle:hover {
            background: #e6e6e6;
        }
        #exportToggle::before { content: '☰'; }
        #exportMenu {
            position: absolute;
            top: 34px;
            right: 0;
            min-width: 200px;
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.25);
            border-radius: 2px;
            padding: 5px 0;
            box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 10;
        }
        #exportMenu[data-open="true"] { display: block; }
        #exportMenu button {
            width: 100%;
            text-align: left;
            border: 0;
            background: transparent;
            color: rgba(0, 0, 0, 0.85);
            padding: 6px 12px;
            border-radius: 0;
            cursor: pointer;
            font: inherit;
            font-size: 12px;
            line-height: 1.3;
        }
        #exportMenu button:hover {
            background: #f2f2f2;
        }
        .export-separator {
            height: 1px;
            background: #e6e6e6;
            margin: 5px 0;
        }
        #container {
            width: 100%;
            min-height: 560px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="card">
            <div class="header">
                <div>
                    <h1>Equipos por región</h1>
                    <p class="subtitle">Total de equipos FONDEQUIP por región de instalación (último ETL).</p>
                </div>
                <div class="header-actions">
                    <button id="exportToggle" type="button" aria-label="Descargar" title="Descargar"></button>
                    <div id="exportMenu" role="menu" aria-label="Opciones de descarga">
                        <button type="button" id="exportFullscreen" role="menuitem">View in full screen</button>
                        <button type="button" id="exportPrint" role="menuitem">Print chart</button>
                        <div class="export-separator" role="separator"></div>
                        <button type="button" id="exportPNG" role="menuitem">Download PNG image</button>
                        <button type="button" id="exportJPEG" role="menuitem">Download JPEG image</button>
                        <button type="button" id="exportSVG" role="menuitem">Download SVG vector image</button>
                        <div class="export-separator" role="separator"></div>
                        <button type="button" id="exportCSV" role="menuitem">Download CSV</button>
                        <button type="button" id="exportXLS" role="menuitem">Download XLS</button>
                        <div class="export-separator" role="separator"></div>
                        <button type="button" id="exportViewData" role="menuitem">View data table</button>
                    </div>
                </div>
            </div>
            <div id="container"></div>
        </div>
    </div>
    <script>
        const categories = ["Región del Bío-Bío", "Región de Los Ríos", "Región de la Araucanía", "Región de los Lagos"];
        const values = [59, 29, 21, 5];
        const palette = ['#2563EB', '#db2777', '#0ea5e9', '#facc15', '#22c55e', '#a855f7'];

        const baseOptions = {
            chart: {
                type: 'bar',
                backgroundColor: 'transparent',
                reflow: false
            },
            title: {
                text: null
            },
            subtitle: {
                text: null
            },
            exporting: {
                enabled: true,
                buttons: {
                    contextButton: { enabled: false }
                }
            },
            colors: palette,
            xAxis: {
                categories,
                title: { text: null },
                gridLineWidth: 1,
                lineWidth: 0,
                labels: { style: { color: 'var(--text-color)' } }
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'Equipos',
                    align: 'high',
                    style: { color: 'var(--text-color)' }
                },
                labels: {
                    overflow: 'justify',
                    style: { color: 'var(--text-color)' }
                },
                gridLineWidth: 0
            },
            tooltip: {
                valueSuffix: ' equipos'
            },
            plotOptions: {
                bar: {
                    borderRadius: '50%',
                    dataLabels: {
                        enabled: true,
                        format: '{point.y:.0f}'
                    },
                    groupPadding: 0.1
                }
            },
            legend: {
                layout: 'horizontal',
                align: 'left',
                verticalAlign: 'top',
                y: 0,
                x: 0,
                floating: false,
                borderWidth: 0,
                backgroundColor: 'transparent',
                itemMarginBottom: 8
            },
            credits: { enabled: false },
            series: [{
                name: 'Total de equipos',
                data: values,
                colorByPoint: true
            }]
        };

        window.regionChart = Highcharts.chart('container', baseOptions);

        function resizeFrame() {
            if (!window.frameElement) return;
            const doc = document.documentElement;
            const body = document.body;
            const height = Math.max(
                doc ? doc.scrollHeight : 0,
                body ? body.scrollHeight : 0
            );
            if (height) window.frameElement.style.height = `${height}px`;
        }

        const exportToggle = document.getElementById('exportToggle');
        const exportMenu = document.getElementById('exportMenu');

        function setMenuOpen(isOpen) {
            exportMenu.dataset.open = isOpen ? 'true' : 'false';
        }

        exportToggle.addEventListener('click', (event) => {
            event.stopPropagation();
            setMenuOpen(exportMenu.dataset.open !== 'true');
        });

        document.addEventListener('click', () => setMenuOpen(false));

        document.getElementById('exportFullscreen').addEventListener('click', (event) => {
            event.stopPropagation();
            setMenuOpen(false);
            const chart = window.regionChart;
            if (chart.fullscreen && typeof chart.fullscreen.toggle === 'function') {
                chart.fullscreen.toggle();
            } else if (document.documentElement && document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            }
        });

        document.getElementById('exportPrint').addEventListener('click', (event) => {
            event.stopPropagation();
            setMenuOpen(false);
            window.regionChart.exporting.print();
        });

        document.getElementById('exportPNG').addEventListener('click', (event) => {
            event.stopPropagation();
            setMenuOpen(false);
            window.regionChart.exporting.exportChart({ type: 'image/png' });
        });
        document.getElementById('exportJPEG').addEventListener('click', (event) => {
            event.stopPropagation();
            setMenuOpen(false);
            window.regionChart.exporting.exportChart({ type: 'image/jpeg' });
        });
        document.getElementById('exportSVG').addEventListener('click', (event) => {
            event.stopPropagation();
            setMenuOpen(false);
            window.regionChart.exporting.exportChart({ type: 'image/svg+xml' });
        });
        document.getElementById('exportCSV').addEventListener('click', (event) => {
            event.stopPropagation();
            setMenuOpen(false);
            window.regionChart.exporting.downloadCSV();
        });
        document.getElementById('exportXLS').addEventListener('click', (event) => {
            event.stopPropagation();
            setMenuOpen(false);
            window.regionChart.exporting.downloadXLS();
        });
        document.getElementById('exportViewData').addEventListener('click', (event) => {
            event.stopPropagation();
            setMenuOpen(false);
            window.regionChart.exporting.viewData();
            window.setTimeout(resizeFrame, 50);
            window.setTimeout(resizeFrame, 250);
        });
    </script>
</body>
</html>
